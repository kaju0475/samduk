name: Hourly System Backup
on:
  schedule:
    # 매시간 정각(0분)에 실행
    - cron: '0 * * * *'
  workflow_dispatch: # 수동 실행 버튼 추가

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Create Backup Directory
        run: mkdir -p backups

      - name: Trigger and Download Backup
        run: |
          # 현재 날짜로 파일명 생성
          FILENAME="backup-$(date +'%Y-%m-%d-%H-%M').json"

          # 프로덕션 서버의 백업 API 호출 및 결과 저장
          curl -X GET "${{ secrets.PRODUCTION_URL }}/api/system/backup/now" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail \
          --output "backups/$FILENAME"

          echo "Backup saved to backups/$FILENAME"

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-backup
          path: backups/*.json
          retention-days: 30
